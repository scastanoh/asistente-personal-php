<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Asistente Personal</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;margin:0;background-color:#f0f2f5;display:flex;justify-content:center;align-items:center;height:100vh}
        .chat-container{width:100%;max-width:600px;height:80vh;background-color:#fff;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.1);display:flex;flex-direction:column;overflow:hidden}
        .chat-header{background-color:#4CAF50;color:#fff;padding:15px;font-size:1.2em;font-weight:700;text-align:center}
        .chat-messages{flex-grow:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column;white-space:pre-wrap;}
        .message{max-width:75%;padding:10px 15px;border-radius:18px;margin-bottom:10px;line-height:1.4;position:relative}
        .message.user{background-color:#0084ff;color:#fff;align-self:flex-end}
        .message.bot{background-color:#e4e6eb;color:#050505;align-self:flex-start}
        .message-buttons{margin-top:10px;display:flex;flex-direction:column;gap:5px;align-items:flex-start;}
        .message-button{background-color:#fff;border:1px solid #4CAF50;color:#4CAF50;border-radius:15px;padding:8px 12px;cursor:pointer;text-align:center;font-weight:700;}
        .message-button:hover{background-color:#f1f1f1;}
        .chat-input-form{display:flex;padding:10px;border-top:1px solid #ddd}
        .chat-input-form input{flex-grow:1;border:1px solid #ccc;border-radius:18px;padding:10px 15px;font-size:1em;outline:0}
        .chat-input-form button{background-color:#4CAF50;color:#fff;border:0;padding:0 15px;margin-left:10px;border-radius:18px;cursor:pointer;font-size:1em;font-weight:700}
        .chat-input-form button:hover{background-color:#45a049}
        .correction-panel{background-color:#f9f9f9;border:1px solid #ddd;border-radius:8px;padding:10px;margin-top:5px;display:flex;flex-direction:column;gap:5px;}
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">Asistente IA</div>
        <div class="chat-messages" id="chat-messages">
             <div class="message bot">¡Hola! Envíame un comando.</div>
        </div>
        <form class="chat-input-form" id="chat-form">
            <input type="text" id="user-input" placeholder="Escribe tu mensaje..." autocomplete="off">
            <button type="submit">Enviar</button>
        </form>
    </div>

    <script>
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const messagesContainer = document.getElementById('chat-messages');
        window.addEventListener('load', () => {
            // Simula que el bot envía un "hola" para iniciar la conversación
            sendMessageToBot('hola');
        });
        chatForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const messageText = userInput.value.trim();
            if (messageText === '') return;
            addMessage(messageText, 'user');
            userInput.value = '';
            sendMessageToBot(messageText);
        });

        function addMessage(text, type, data = {}) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('message', type);
            const textElement = document.createElement('div');
            textElement.innerText = text;
            messageWrapper.appendChild(textElement);

            // ¡NUEVA LÓGICA DE BOTONES!
            if (type === 'bot' && data.intencion === 'añadir_tarea' && data.extracted_data) {
                const buttonsContainer = document.createElement('div');
                buttonsContainer.classList.add('message-buttons');
                const btnYes = document.createElement('button');
                btnYes.innerText = '✅ Sí, guardar';
                btnYes.classList.add('message-button');
                btnYes.onclick = () => {
                    const saveData = { ...data.extracted_data };
                    // Enviamos un comando interno al backend
                    sendMessageToBot('guardar_tarea_corregida', saveData);
                    buttonsContainer.innerHTML = '<span>Guardando...</span>';
                };
                buttonsContainer.appendChild(btnYes);

                const btnNo = document.createElement('button');
                btnNo.innerText = '❌ No, corregir';
                btnNo.classList.add('message-button');
                btnNo.onclick = () => {
                    showCorrectionForm(messageWrapper, data.extracted_data);
                    buttonsContainer.remove();
                };
                buttonsContainer.appendChild(btnNo);

                messageWrapper.appendChild(buttonsContainer);
            }
            messagesContainer.appendChild(messageWrapper);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function showCorrectionForm(messageWrapper, initialData) {
            const formContainer = document.createElement('div');
            formContainer.classList.add('correction-panel');
            formContainer.innerHTML = `
                <input type="text" id="desc-corr" value="${initialData.descripcion || ''}" placeholder="Descripción">
                <input type="date" id="fecha-corr" value="${initialData.fecha || ''}">
                <input type="time" id="hora-corr" value="${initialData.hora || ''}">
                <button id="btn-save-corr" class="message-button">Guardar Corrección</button>
            `;
            messageWrapper.appendChild(formContainer);

            document.getElementById('btn-save-corr').onclick = () => {
                const correctedData = {
                    descripcion: document.getElementById('desc-corr').value,
                    fecha: document.getElementById('fecha-corr').value,
                    hora: document.getElementById('hora-corr').value || '09:00'
                };
                // Enviamos el comando interno con los datos corregidos
                sendMessageToBot('guardar_tarea_corregida', correctedData);
                formContainer.innerHTML = '<span>Guardando corrección...</span>';
            };
        }

        async function sendMessageToBot(text, payloadData = null) {
            const formData = new URLSearchParams();
            formData.append('driver', 'web');
            formData.append('userId', '12345');
            formData.append('message', text);
            
            // Si hay datos (payload), es un comando interno del frontend
            if(payloadData) {
                formData.append('is_internal', '1');
                formData.append('internal_intent', text); // La intención es el 'comando'
                formData.append('payload_data', JSON.stringify(payloadData));
                formData.set('message', text); // Sobreescribimos el mensaje con el comando
            }
            
            try {
                const response = await fetch('chatbot.php', { method: 'POST', body: formData });
                const data = await response.json();
                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => {
                        addMessage(msg.text, 'bot', msg.additionalParameters);
                    });
                }
            } catch (error) { addMessage("Lo siento, hubo un error de conexión.", 'bot'); }
        }
    </script>
</body>
</html>